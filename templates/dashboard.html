<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agentic Engine Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; padding-bottom: 80px; }
    .container { max-width: 1100px; margin: 18px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:8px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,0.03); }
    .flex { display:flex; gap:12px; align-items:center; }
    .chart-wrap { width:260px; min-width:180px; }
    .summary { flex:1; }
    .small { font-size:0.9rem; color:#666; }
    /* fixed footer for exports */
    .fixed-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      padding: 10px 16px;
      background: rgba(255,255,255,0.98);
      border-top: 1px solid #eee;
      z-index: 999;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.03);
    }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fafafa; cursor:pointer; margin:0 6px; }
    .btn-primary { background:#0b5fff; color:white; border-color:#0b5fff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dashboard</h2>

    <div class="card flex" style="align-items:flex-start;">
      <div class="chart-wrap">
        <canvas id="apiToolsChart" width="260" height="260"></canvas>
      </div>
      <div class="summary">
        <h3 style="margin:0 0 6px 0">API vs Tools</h3>
        <div class="small">Overview of calls and tool usage. The donut chart groups items with "API" in the name as "API".</div>
        <div id="breakdown" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- other dashboard cards / content below -->
    <div style="height: 16px;"></div>

    <div class="card">
      <h4 style="margin-top:0">Recent Decisions</h4>
      <div id="decisions" class="small">Loadingâ€¦</div>
    </div>

  </div>

  <div class="fixed-footer">
    <button class="btn" onclick="window.location.href='/decisions/pending'">View Pending Decisions</button>
    <button class="btn" onclick="downloadCSV()">Export CSV</button>
    <button class="btn btn-primary" onclick="downloadJSON()">Export JSON</button>
  </div>

  <script>
    async function fetchUsage() {
      try {
        const resp = await fetch('/api/tool_usage');
        const data = await resp.json();
        renderChart(data);
        renderBreakdown(data.breakdown || {});
      } catch (e) {
        console.error(e);
      }
    }

    function renderBreakdown(breakdown) {
      const el = document.getElementById('breakdown');
      const lines = [];
      for (const [tool, cnt] of Object.entries(breakdown)) {
        lines.push(`<div style="display:flex;justify-content:space-between;padding:4px 0"><div>${tool}</div><div style="color:#333">${cnt}</div></div>`);
      }
      el.innerHTML = lines.join('');
    }

    let chart;
    function renderChart(data) {
      const ctx = document.getElementById('apiToolsChart').getContext('2d');
      const values = [data.api || 0, data.tools || 0];
      const labels = ['API', 'Tools'];
      const colors = ['#1778f2', '#ffa500'];
      if (chart) {
        chart.data.datasets[0].data = values;
        chart.update();
        return;
      }
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data: values, backgroundColor: colors, borderWidth: 1 }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels:{boxWidth:10} } },
          layout: { padding: 6 },
        }
      });
    }

    async function downloadCSV() {
      // simple endpoint reuse for demo - fetch decisions endpoint and convert to CSV
      const resp = await fetch('/decisions/pending');
      const txt = await resp.text();
      // naive CSV: store as a text file for user to download
      const blob = new Blob([txt], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'decisions.csv'; a.click(); URL.revokeObjectURL(url);
    }
    async function downloadJSON() {
      const resp = await fetch('/decisions/pending');
      try {
        const json = await resp.json();
        const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'decisions.json'; a.click(); URL.revokeObjectURL(url);
      } catch (e) {
        // fallback: treat as text
        const txt = await resp.text();
        const blob = new Blob([txt], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'decisions.json'; a.click(); URL.revokeObjectURL(url);
      }
    }

    // initial load
    fetchUsage();
    // refresh periodically
    setInterval(fetchUsage, 20_000);
  </script>
</body>
</html>
